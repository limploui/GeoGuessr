<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- Mapillary JS + CSS (CDN) einbinden -->
    <link rel="stylesheet" href="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.css" />
    <script src="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.js"></script>

    <title>Mapillary Viewer</title>

    <style>
        /* Basis: Vollbild, dunkler Hintergrund, System-Schrift */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
          background: #000;
          color: #fff;
          font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }
        /* Viewer füllt den kompletten WebView */
        #mly {
          position: fixed;
          inset: 0;
        }
        /* Kleine Fehlerleiste unten (nur bei Fehler sichtbar) */
        #err {
          position: fixed;
          left: 0; right: 0; bottom: 0;
          padding: 8px 12px;
          background: rgba(220, 53, 69, 0.9);
          color: #fff;
          font-size: 12px;
          display: none;
          white-space: pre-wrap;
        }
        /* Hinweis falls JS deaktiviert wäre */
        noscript {
          position: fixed; inset: 0;
          display: grid; place-items: center;
          background: #111; color: #f55;
          font-size: 14px; text-align: center;
          padding: 16px;
        }
    </style>
</head>
<body>
<!-- Container für den Mapillary Viewer -->
<div id="mly"></div>
<!-- Overlay für Fehlermeldungen -->
<div id="err"></div>
<noscript>Diese Seite benötigt JavaScript.</noscript>

<script>
    // ===== Fehler-Overlay (global) ==========================================
    (function attachGlobalErrorHandlers() {
      const errBox = document.getElementById("err");
      function showErr(msg) {
        if (!errBox) return;
        errBox.style.display = "block";
        errBox.textContent = msg.toString();
        console.error("[MJS][Overlay]", msg);
      }
      window.addEventListener("error", (e) => showErr(e.message || e.error || e));
      window.addEventListener("unhandledrejection", (e) => showErr(e.reason || e));
    })();

    // ===== Globaler State für Viewer & Warteschlange ========================
    window.MLY = {
      viewer: null,          // Mapillary Viewer-Instanz
      ready: false,          // wird true, wenn 'load' gefeuert hat
      queue: [],             // Bild-IDs, die vor 'ready' angefordert wurden
      firstId: null,         // erste Ziel-ID beim Start
      firstFramePending: false, // true: warte auf erstes sichtbares Bild nach moveTo()
    };

    // moveTo-Helfer mit Logging
    function tryMove(id, reason) {
      if (!id) { console.warn("[MJS] tryMove ohne ID:", id, "reason:", reason); return; }
      if (!window.MLY.viewer) { console.warn("[MJS] tryMove ohne viewer:", id, "reason:", reason); return; }

      // ab jetzt auf erstes Frame warten (für Android-Callback)
      window.MLY.firstFramePending = true;

      window.MLY.viewer
        .moveTo(id)
        .then(() => console.log("[MJS] moveTo OK:", id, "reason:", reason))
        .catch(err => console.error("[MJS] moveTo FAILED:", id, "reason:", reason, err));
    }

    // Prüfen, ob Mapillary-Bibliothek geladen ist
    function ensureLibraryAvailable() {
      const ok = (typeof window.mapillary !== "undefined")
                 && window.mapillary
                 && typeof window.mapillary.Viewer === "function";
      console.log("[MJS] mapillary verfügbar:", ok ? "ja" : "nein");
      return ok;
    }

    // ===== Init: wird aus Android via evaluateJavascript aufgerufen =========
    window.init = function (accessToken, imageId) {
      console.log("[MJS] init called. mapillary =", typeof window.mapillary);

      // Falls die Lib noch nicht bereit ist → kurz später erneut probieren
      if (!ensureLibraryAvailable()) {
        console.warn("[MJS] mapillary noch nicht bereit – retry in 200ms");
        setTimeout(() => window.init(accessToken, imageId), 200);
        return;
      }

      // Bereits existierenden Viewer wiederverwenden
      if (window.MLY.viewer) {
        console.log("[MJS] Viewer existiert bereits – setze Bild direkt");
        window.MLY.firstId = imageId;
        if (window.MLY.ready) {
          tryMove(imageId, "init_reuse_ready");
        } else {
          window.MLY.queue.push(imageId);
          console.log("[MJS] viewer not ready; queued", imageId);
        }
        return;
      }

      // Erste Ziel-ID vormerken
      window.MLY.firstId = imageId;

      // Viewer erzeugen (Container: #mly)
      const { Viewer } = window.mapillary;
      const v = new Viewer({
        accessToken: accessToken, // nur Token (kein "OAuth ")
        container: 'mly'
      });
      window.MLY.viewer = v;
      window._viewer = v;        // optional: globaler Handle für Android-Hooks
      console.log("[MJS] Viewer created");

      // 'load' → Viewer ist initialisiert
      v.on('load', () => {
        console.log("[MJS] Viewer ready");
        window.MLY.ready = true;

        // direkt zu firstId springen, falls vorhanden
        if (window.MLY.firstId) {
          tryMove(window.MLY.firstId, "on_load_firstId");
        }

        // ggf. aufgelaufene setImage-Calls abarbeiten
        while (window.MLY.queue.length) {
          const id = window.MLY.queue.shift();
          tryMove(id, "on_load_queue");
        }
      });

      // 'image' → wird bei jedem Bildwechsel gefeuert
      v.on('image', e => {
        const id = e && e.image && e.image.id;
        console.log("[MJS] Bild geladen:", id);

        // Erstes sichtbares Frame nach moveTo → Android informieren (einmalig)
        if (window.MLY.firstFramePending) {
          window.MLY.firstFramePending = false;
          if (window.AndroidBridge && typeof AndroidBridge.onFirstImageRendered === 'function') {
            try { AndroidBridge.onFirstImageRendered(); } catch(_) {}
          }
        }
      });

      // Watchdog: falls 'load' unerwartet lange ausbleibt
      setTimeout(() => {
        if (!window.MLY.ready && window.MLY.firstId) {
          console.warn("[MJS] Viewer noch nicht ready nach 2000ms – Watchdog versucht moveTo()");
          tryMove(window.MLY.firstId, "watchdog");
        }
      }, 2000);
    };

    // ===== Bildwechsel: wird aus Android aufgerufen =========================
    window.setImage = function (imageId) {
      if (!window.MLY.viewer || !window.MLY.ready) {
        console.log("[MJS] viewer not ready; queue", imageId);
        window.MLY.queue.push(imageId);
        return;
      }
      tryMove(imageId, "setImage");
    };
</script>
</body>
</html>
